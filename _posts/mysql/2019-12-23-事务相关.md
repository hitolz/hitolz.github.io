---
layout: post
title: 事务相关
tags: [MySQL,事务]
categories: [MySQL]
---
[toc]
## 事务的基本要素 - ACID

1. 原子性（Atomicity）：事务开始后所有操作，要么全部做完，要么全部不做，不可能停滞在中间环节。事务执行过程中出错，会回滚到事务开始前的状态，所有的操作就像没有发生一样。也就是说事务是一个不可分割的整体。

2. 一致性（Consistency）：事务开始前和结束后，数据库的完整性约束没有被破坏 。
   1. 例如，在表中有一个字段为姓名，为唯一约束，即在表中不能重复。如果一个事务对姓名字段进行了修改，但是在事务提交或事务回滚后，表中的姓名变得非唯一了，这就破坏了事务的一致性要求，即事务将数据库从一种状态变为了一种不一致的状态。

3. 隔离性（Isolation）：同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰。
   1. 隔离性还有其他称呼，如并发控制、可串行化、锁
   2. 隔离性要求每个读写事务的对象对其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见，通常使用锁来实现。

4. 持久性（Durability）：事务完成后，事务对数据库的所有更新将被保存到数据库，不能回滚。



## 事务的实现

### redo

### undo

### purge

### group commit



## MySQL事务隔离级别

SQL标准定义的四个隔离级别：

| 事务隔离级别                 | 脏读 | 不可重复读 | 幻读 |
| ---------------------------- | ---- | ---------- | ---- |
| 读未提交（read-uncommitted） | 是   | 是         | 是   |
| 不可重复读（read-committed） | 否   | 是         | 是   |
| 可重复读（repeatable-read）  | 否   | 否         | 是   |
| 串行化（serializable）       | 否   | 否         | 否   |



## 事务的并发问题

1. 脏读
   
   **读取事务未提交的数据**
   
   A事务读取了B事务未提交的数据，当B事务回滚后，A读到的数据就是脏数据。
   
2. 幻读

   **前后多次读取，数据总量不一致**

   A事务需要读取两次数据，前一次查询之后，B事务执行，新增了数据，A再去查询，发现两次查询数量不一致，就像产生了幻觉一样。

3. 不可重复读

   **前后多次多去，数据内容不一致**

   A事务需要读取两次数据，前一次查询之后，B事务执行，修改了数据，A再去查询，发现两次查询到的内容不一致。



不可重复读与幻读有什么区别？

不可重复读是读取了其他事务修改的数据，针对insert与update操作

幻读是读取了其他事务新增的数据，针对insert与delete操作



| 不可重复读               | 幻读                     |
| ------------------------ | ------------------------ |
| 读取了其他事务修改的数据 | 读取了其他事务新增的数据 |
| 针对insert与update操作   | 针对insert与delete操作   |
| 解决：<br />使用行级锁   | 解决：<br />使用表级锁   |



## Spring事务隔离级别

@Transactional 注解

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
public @interface Transactional {
    String value() default "";
	// 传播机制
    Propagation propagation() default Propagation.REQUIRED;
	// 隔离级别
    Isolation isolation() default Isolation.DEFAULT;

    int timeout() default -1;

    boolean readOnly() default false;

    Class<? extends Throwable>[] rollbackFor() default {};

    String[] rollbackForClassName() default {};

    Class<? extends Throwable>[] noRollbackFor() default {};

    String[] noRollbackForClassName() default {};
}
```



Isolation枚举：

```java
public enum Isolation {
    DEFAULT(-1),
    READ_UNCOMMITTED(1),
    READ_COMMITTED(2),
    REPEATABLE_READ(4),
    SERIALIZABLE(8);

    private final int value;

    private Isolation(int value) {
        this.value = value;
    }

    public int value() {
        return this.value;
    }
}

```

`DEFAULT`使用数据库默认的隔离级别

另外的与SQL标准定义的四个隔离级别一样













## 参考资料
https://www.cnblogs.com/huanongying/p/7021555.html